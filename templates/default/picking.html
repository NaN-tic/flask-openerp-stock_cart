{% extends "default/layout.html" %}
{% block title %}{{ _("Process pickings") }}: {{ session.cart_name }}{% endblock %}
{% block head %}<script src="{{ url_for('static', filename='default/js/jquery.validate.js') }}" type="text/javascript"></script>{% endblock %}
{% block body %}
{% include 'default/nav.html' %}
<div class="row">
    <div class="span12">
    <table class="table table-striped table-condensed">
        <thead>
            <tr>
                <th>{{ _("Code") }}</th>
                <th>{{ _("Product") }}</th>
                <th>{{ _("Qty") }}</th>
                <th>{{ _("Qty Available") }}</th>
                <th>{{ _("Rack") }}</th>
                <th>{{ _("Row") }}</th>
                <th>{{ _("Case") }}</th>
            </tr>
        </thead>
        <tbody>
            {% if not products %}<tr><td colspan="7">{{ _('There are not pickings to process') }}</td></tr>{% endif %}
            {% for product in products %}<tr class="{% if product.qty_available <= 0 %}stock-alert{% endif %}">
                <td><strong>{{ product.code }}</strong></td>
                <td><a href="#{{ product.id }}" data-toggle="modal" data-target="#{{ product.id }}">{{ product.name }}</a></td>
                <td><strong>{{ product.qty }}</strong></td>
                <td>{{ product.qty_available }}</td>
                <td>{% if product.loc_rack %}{{ product.loc_rack }}{% endif %}</td>
                <td>{% if product.loc_row %}{{ product.loc_row }}{% endif %}</td>
                <td>{% if product.loc_case %}{{ product.loc_case }}{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

{% for product in products recursive %}{% if products[loop.index] %}{% set next_product = products[loop.index] %}{% endif %}
<div id="{{ product.id }}" class="modal hide fade" tabindex="-1" data-width="760">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3>{{ product.name }}
          <i class="icon-info-sign product-info" data-toggle="tooltip" data-html="true" data-placement="bottom" title="{{ product|productinfo }}"></i>
        </h3>
    </div>
    <div class="modal-body">
        <form action="#" id="{{ product.id }}-form" class="form-horizontal" method="POST">
        <div class="row-stockcart">
            <div class="span6"><strong>{{ _('Reference') }}:</strong> {{ product.code }}</div>
            <div class="span6"><strong>{{ _('Manufacturer') }}:</strong> {{ product.manufacturer }}</div>
        </div>
        <div class="row-stockcart">
            <div class="span6"><strong>{{ _('Qty') }}:</strong> {{ product.qty }}</div>
            <div class="span6{% if product.qty_available <= 0 %} stock-alert{% endif %}"><strong>{{ _('Qty Available') }}:</strong> {{ product.qty_available }}</div>
        </div>
        <div class="box-ean13">
            <input type="number" id="ean-{{product.ean13}}" name="ean-{{product.ean13}}" autofocus="autofocus"> 
            <a id="{{product.ean13}}" href="#{{product.ean13}}" class="get-ean13 btn btn-primary{% if loop.last %} last-prod{% endif %}">{{ _('Find') }}</a>
            <a href="#{{product.ean13}}" class="clean-ean13 btn">{{ _('Clean') }}</a>
            <a href="#{{product.ean13}}" class="show-stockcart btn{% if loop.last %} last-prod{% endif %}">{{ _('Continue') }}</a>
        </div>
        <hr/>
        <div class="box-stockcart {{product.ean13}}">
            <div class="row-stockcart">{% set count = 0 %}{% for cell in range(session.cart_rows*session.cart_columns) %}{% if count < grid|length %}
            {% if count is divisibleby session.cart_columns  %}{% if not count == 0 %}</div>
            <div class="row-stockcart">{% endif %}{% endif %}
                    <div class="span{{ (12 / session.cart_columns)|floatwithoutdecimal }} basket">{% set cell = loop.index %}{% set picking_cell_name = grid|pickingname(cell) %}
                        <h5>{{ cell }} - {{ picking_cell_name }}</h5>{% for picking in product.pickings %}{% if picking.name == picking_cell_name %}
                        <p>
                            <input type="number" id="{{picking.move}}" name="{{picking.move}}" min="1" value="{% if not product.qty_available < 0 %}{{ picking.qty }}{% else %}0{% endif %}" class="required input-mini" autofocus="autofocus" required><br/>
                            {% if product.qty_available <= 0 %}<span class="stock-alert">({{ _('Qty') }}: {{ picking.qty }})</span>{% endif %}
                        </p>{% endif %}{% endfor %}
                    </div>{% set count = count + 1 %}{% endif %}{% endfor %}
            </div>
        </div>
        </form>
        <script type="text/javascript">
        $('#ean-{{product.ean13}}').change(function() {
            var value = $('#ean-{{product.ean13}}').val();
            if(value == '{{product.ean13}}'){
                $('#{{product.ean13}}').trigger('click');
            }
        });
        </script>
    </div>
    <div class="modal-footer">
        <button type="button" data-dismiss="modal" class="btn">{{ _('Close') }}</button>
        {% if not loop.last %}<button id="{{product.id}}-{{ next_product['id'] }}" type="button" data-dismiss="modal" class="btn btn-primary next-product next-{{ product.ean13 }}">{{ _('Send and next') }}</button>{% endif %}
        {% if loop.last %}<button id="{{product.id}}" type="button" data-dismiss="modal" class="btn btn-primary last-product">{{ _('Send and Done') }}</button>{% endif %}
    </div>
</div>
{% endfor %}
<div id="send-pickings-done">
    <a id="pickings-info" href="#" data-toggle="modal" data-target="#pickings" class="btn btn-primary">{{ _('Pickings info and Done') }}</a>
</div>

{% if grid|length %}<!-- legend -->
<hr/>
<h4>{{ _('Grid Cart') }}</h4>
<div class="row-stockcart">{% set count = 0 %}{% for cell in range(session.cart_rows*session.cart_columns) %}{% if count < grid|length %}
{% if count is divisibleby session.cart_columns  %}{% if not count == 0 %}</div>
<div class="row-stockcart">{% endif %}{% endif %}
        <div class="span{{ (12 / session.cart_columns)|floatwithoutdecimal }} basket">{% set cell = loop.index %}{% set picking_cell_name = grid|pickingname(cell) %}
            <strong>{{ cell }} - {{ picking_cell_name }}</strong>
        </div>{% set count = count + 1 %}{% endif %}{% endfor %}
</div>{% endif %}

<!-- Modal Window done -->
<div id="send-done" class="modal hide fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3>{{ _('Pickings have been sent and process successfully') }}</h3>
    </div>
    <div class="modal-body">
    <p>{{ _('What do you do?') }}</p>
    <p>
        <a href="{{ url_for('picking') }}">{{ _('Do more pickings to delivery') }}</a> {{_('or')}} <a href="{{ url_for('logout') }}">{{ _('logout') }}</a>
    </p>
    </div>
    <div class="modal-footer">
        <button type="button" data-dismiss="modal" class="btn">{{ _('Done') }}</button>
    </div>
</div>

{% if grid|length %}
<!-- Modal Window Pickings -->
<div id="pickings" class="modal hide fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <form action="#" id="send-pickings-form" class="form-horizontal" method="POST">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3>{{ _('Pickings') }}</h3>
    </div>
    <div class="modal-body">
        {% for g in grid %}{% set picking = loop.index %}{% set name = grid|pickingname(picking) %}{% set products = grid|pickingproducts(picking) %}
        <h4>{{ picking}} - <span class="picking-name">{{ name }}</span> <a href="#{{name}}" id="print-{{name}}" class="btn btn-small btn-success print-picking">{{ _('Print') }}</a></h4>
        <table class="table table-striped table-condensed">
            <thead>
                <tr>
                    <th>{{ _("Code") }}</th>
                    <th>{{ _("Product") }}</th>
                    <th>{{ _("Ordered") }}</th>
                    <th>{{ _("Qty") }}</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}<tr>
                    <td>{{ product['product_code'] }}</strong></td>
                    <td>{{ product['product_name'] }}</td>
                    <td>{{ product['qty'] }}</td>
                    {% set move = product|productmove() %}<td id="qty-{{ move }}"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <input type="hidden" name="{{ name }}" value="1">
        {% endfor %}
    </div>
    <div class="modal-footer">
        <button id="send-pickings" type="button" data-dismiss="modal" class="btn btn-primary">{{ _('Done') }}</button>
    </div>
    </form>
</div>
{% endif %}

<script type="text/javascript">
$('.product-info').tooltip();

/* Box Stockcart */
$(".box-stockcart").hide();
$(".next-product").attr("disabled", "disabled");
$(".last-product").attr("disabled", "disabled");

/* Get EAN13 if is valid */
$(".get-ean13").click(function(event){
    var boxean = $(this).attr('href').replace('#', '.');
    var ean = boxean.slice(1, boxean.length);
    var value = $('#ean-'+ean).val();
    var classes = $(this).attr('class').split(" ");

    if(value != ean){
        alert("{{ _('Not find EAN: ') }}"+value);
        return False;
    }
    $(boxean).show();
    if( $.inArray('last-prod', classes) > 0){
        $('.last-product').removeAttr("disabled"); 
    } else {
        $('.next-'+ean).removeAttr("disabled"); 
    }
});

/* Pass EAN13 if is valid */
$(".show-stockcart").click(function(event){
    var boxean = $(this).attr('href').replace('#', '.');
    var ean = boxean.slice(1, boxean.length);
    var classes = $(this).attr('class').split(" ");

    $(boxean).show();
    if( $.inArray('last-prod', classes) > 0){
        $('.last-product').removeAttr("disabled"); 
    } else {
        $('.next-'+ean).removeAttr("disabled"); 
    }
});

$(".clean-ean13").click(function(event){
    var boxean = $(this).attr('href').replace('#', '.');
    var ean = boxean.slice(1, boxean.length);
    var classes = $(this).attr('class').split(" ");

    $('#ean-'+ean).val('');
});

{% if not products %}$("#send-pickings-done").hide();{% endif %}

/* Next product */
$('.next-product').click(function(){
    var products = this.id.split('-');
    var data = $('#'+products[0]+'-form').serializeArray();

    $.ajax({
        type: "POST",
        url: "{{ url_for('send_move') }}",
        contentType: "application/json; charset=utf-8",
        data:JSON.stringify(data),
        success: function(data) {
            $('#'+products[0]).modal('hide');
            $('#'+products[1]).modal('show');
            },
        error:function(request, status, error){
            alert(request.responseText);
            },
        });
})

/* Last product */
$('.last-product').click(function(){
    var product = this.id;
    var data = $('#'+product+'-form').serializeArray();

    $.ajax({
        type: "POST",
        url: "{{ url_for('send_move') }}",
        contentType: "application/json; charset=utf-8",
        data:JSON.stringify(data),
        success: function(data) {
            $('#pickings').modal('show');
            },
        error:function(request, status, error){
            alert(request.responseText);
            },
        });
})

/* Print picking */
$('.print-picking').click(function(){
    var p = $(this).attr('href').replace('#', '.');
    var data = p.slice(1, p.length);
    $.ajax({
        type: "POST",
        url: "{{ url_for('print_picking') }}",
        contentType: "application/json; charset=utf-8",
        data:JSON.stringify(data),
        success: function(data) {
            $(this).hide();
            },
        error:function(request, status, error){
            alert(request.responseText);
            },
        });
})

/* Send pickings */
$('#send-pickings').click(function(){
    var product = this.id;
    var data = $('#send-pickings-form').serializeArray();

    $.ajax({
        type: "POST",
        url: "{{ url_for('send_pickings') }}",
        contentType: "application/json; charset=utf-8",
        data:JSON.stringify(data),
        success: function(data) {
            $('#send-done').modal('show');
            },
        error:function(request, status, error){
            alert(request.responseText);
            },
        });
})

$('#pickings-info').click(function(){
    // get all qty from stock move
    var pickings = [];
    $(".picking-name").map(function() {
        pickings.push($(this).text());
    });

    $.ajax({
        type: "POST",
        url: "{{ url_for('qty_pickings') }}",
        contentType: "application/json; charset=utf-8",
        data:JSON.stringify(pickings),
        success: function(data) {
            var result = data.result;
            $.each(result, function(index, value){
                $.each(value, function(move, qty){
                    $('#qty-'+move).empty();
                    $('#qty-'+move).append('<strong>'+qty+'</strong>');
                })
            })
            },
        error:function(request, status, error){
            alert(request.responseText);
            },
        });
})

/* Active autofocus */
$(".modal").on('shown', function() {
    $(this).find("[autofocus]:first").focus();
});
</script>
{% endblock %}
