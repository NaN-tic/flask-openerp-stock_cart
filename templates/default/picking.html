{% extends "default/layout.html" %}
{% block title %}{{ _("Select a cart") }}{% endblock %}
{% block head %}<script src="{{ url_for('static', filename='default/js/jquery.validate.js') }}" type="text/javascript"></script>{% endblock %}
{% block body %}
{% include 'default/nav.html' %}
<div class="row">
    <div class="span12">
    <table class="table table-striped table-condensed">
        <thead>
            <tr>
                <th>{{ _("Code") }}</th>
                <th>{{ _("Product") }}</th>
                <th>{{ _("Qty") }}</th>
                <th>{{ _("Qty Available") }}</th>
                <th>{{ _("Rack") }}</th>
                <th>{{ _("Row") }}</th>
                <th>{{ _("Case") }}</th>
            </tr>
        </thead>
        <tbody>
            {% if not products %}<tr><td colspan="7">{{ _('There are not pickings to process') }}</td></tr>{% endif %}
            {% for product in products %}<tr class="{% if product.qty_available <= 0 %}stock-alert{% endif %}">
                <td><strong>{{ product.code }}</strong></td>
                <td><a href="#{{ product.id }}" data-toggle="modal" data-target="#{{ product.id }}">{{ product.name }}</a></td>
                <td><strong>{{ product.qty }}</strong></td>
                <td>{{ product.qty_available }}</td>
                <td>{% if product.loc_rack %}{{ product.loc_rack }}{% endif %}</td>
                <td>{% if product.loc_row %}{{ product.loc_row }}{% endif %}</td>
                <td>{% if product.loc_case %}{{ product.loc_case }}{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
</div>

<form action="#" id="basket-form" class="form-horizontal" method="POST">
    {% for product in products recursive %}{% if products[loop.index] %}{% set next_product = products[loop.index] %}{% endif %}
    <div id="{{ product.id }}" class="modal hide fade" tabindex="-1" data-width="760">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3>{{ product.name }}
              <i class="icon-info-sign product-info" data-toggle="tooltip" data-html="true" data-placement="bottom" title="{{ product|productinfo }}"></i>
            </h3>
        </div>
        <div class="modal-body">
            <div class="row-stockcart">
                <div class="span6"><strong>{{ _('Qty') }}:</strong> {{ product.qty }}</div>
                <div class="span6{% if product.qty_available <= 0 %} stock-alert{% endif %}"><strong>{{ _('Qty Available') }}:</strong> {{ product.qty_available }}</div>
            </div>
            <hr/>
            <div class="row-stockcart">{% set count = 0 %}{% for cell in range(session.cart_rows*session.cart_columns) %}{% if count < grid|length %}
            {% if count is divisibleby session.cart_columns  %}{% if not count == 0 %}</div>
            <div class="row-stockcart">{% endif %}{% endif %}
                    <div class="span{{ (12 / session.cart_columns)|floatwithoutdecimal }} basket">{% set cell = loop.index %}{% set picking_cell_name = grid|pickingname(cell) %}
                        <h4>{{ cell }} - {{ picking_cell_name }}</h4>{% for picking in product.pickings %}{% if picking.name == picking_cell_name %}
                        <p>
                            <input type="number" name="{{picking.move}}" min="1" value="{% if not product.qty_available < 0 %}{{ picking.qty }}{% else %}0{% endif %}" class="qty-cart required input-mini" required><br/>
                            {% if product.qty_available <= 0 %}<span class="stock-alert">({{ _('Qty') }}: {{ picking.qty }})</span>{% endif %}
                        </p>{% endif %}{% endfor %}
                    </div>{% set count = count + 1 %}{% endif %}{% endfor %}
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" data-dismiss="modal" class="btn">{{ _('Close') }}</button>
            {% if not loop.last %}<button id="{{product.id}}-{{ next_product['id'] }}" type="button" data-dismiss="modal" class="btn btn-primary next-product">{{ _('Next') }}</button>{% endif %}
        </div>
    </div>
    {% endfor %}
    <div id="send-process">
        <button type="submit" class="btn btn-primary">{{ _('Process') }}</button>
    </div>
</form>

{% if grid|length %}<!-- legend -->
<hr/>
<h4>{{ _('Grid Cart') }}</h4>
<div class="row-stockcart">{% set count = 0 %}{% for cell in range(session.cart_rows*session.cart_columns) %}{% if count < grid|length %}
{% if count is divisibleby session.cart_columns  %}{% if not count == 0 %}</div>
<div class="row-stockcart">{% endif %}{% endif %}
        <div class="span{{ (12 / session.cart_columns)|floatwithoutdecimal }} basket">{% set cell = loop.index %}{% set picking_cell_name = grid|pickingname(cell) %}
            <strong>{{ cell }} - {{ picking_cell_name }}</strong>
        </div>{% set count = count + 1 %}{% endif %}{% endfor %}
</div>{% endif %}

<!-- Modal Window done -->
<div id="send-done" class="modal hide fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3>{{ _('Send quantity products successfully') }}</h3>
    </div>
    <div class="modal-body">
    <p><a href="{{ url_for('picking') }}">{{ _('Get more products/pickings to do') }}</a></p>
    </div>
    <div class="modal-footer">
        <button type="button" data-dismiss="modal" class="btn">{{ _('Done') }}</button>
    </div>
</div>

<!-- Modal Window error -->
<div id="send-error" class="modal hide fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3>{{ _('Error!') }}</h3>
    </div>
    <div class="modal-body">
    <p>{{ _('Qty are integer values? Review your cart and resend') }}</p>
    </div>
    <div class="modal-footer">
        <button type="button" data-dismiss="modal" class="btn">{{ _('Check') }}</button>
    </div>
</div>

<script type="text/javascript">
$('.product-info').tooltip();
{% if not products %}$("#send-process").hide();{% endif %}

$("#basket-form").submit(function () {
    var data = $('#basket-form').serializeArray();

    $.ajax({
        type: "POST",
        url: "{{ url_for('basket') }}",
        contentType: "application/json; charset=utf-8",
        data:JSON.stringify(data),
        success: function(data) {
            $('#send-done').modal('show');
            $("#send-process").hide();
            },
        error:function(data){
            $('#send-error').modal('show');
            },
        });
       return false;
});

$(".qty-cart").on("keyup", function() {
    if (this.value.length <= 3) {
        $(this).tooltip("show");
    } else {
        $(this).tooltip("hide");
    }
}).tooltip({
    placement: "right",
    trigger: "focus",
    title: "{{ _('Qty added in this basket ') }} "
});

/* Next product */
$('.next-product').click(function(){
   var products = this.id.split('-');
   $('#'+products[0]).modal('hide');
   $('#'+products[1]).modal('show');
})
</script>
{% endblock %}
